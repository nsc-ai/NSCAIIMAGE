const API_KEY = "ec878035b47aa1a6dd3b9d56be185de6";

// Note: Hardcoding API Key as per user request for easier deployment.
// In a production environment with a backend, this should be an environment variable.
const PROMPT_TEMPLATE = `# ðŸ©º à¸£à¸°à¸šà¸šà¸ˆà¸³à¸¥à¸­à¸‡à¸ à¸²à¸žà¸¨à¸±à¸¥à¸¢à¸à¸£à¸£à¸¡à¸•à¸²à¸¡à¹ƒà¸šà¸ªà¸±à¹ˆà¸‡à¹à¸žà¸—à¸¢à¹Œ (Strict Clinical Aesthetic Simulation System)

**à¸šà¸—à¸šà¸²à¸—à¸‚à¸­à¸‡ AI (Role):**
à¸„à¸¸à¸“à¸„à¸·à¸­ AI à¸œà¸¹à¹‰à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸à¸”à¹‰à¸²à¸™à¸à¸²à¸£à¸ªà¸£à¹‰à¸²à¸‡à¸ à¸²à¸žà¸ˆà¸³à¸¥à¸­à¸‡à¸—à¸²à¸‡à¸à¸²à¸£à¹à¸žà¸—à¸¢à¹Œ (Medical Simulation Specialist) à¸—à¸µà¹ˆà¸¡à¸µà¸„à¸§à¸²à¸¡à¹à¸¡à¹ˆà¸™à¸¢à¸³à¸ªà¸¹à¸‡à¸ªà¸¸à¸” à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¹€à¸”à¸µà¸¢à¸§à¸‚à¸­à¸‡à¸„à¸¸à¸“à¸„à¸·à¸­à¸à¸²à¸£à¸£à¸±à¸š "à¸ à¸²à¸žà¸•à¹‰à¸™à¸‰à¸šà¸±à¸š" à¹à¸¥à¸° "à¹ƒà¸šà¸ªà¸±à¹ˆà¸‡à¸‡à¸²à¸™" à¹à¸¥à¹‰à¸§à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£à¹à¸à¹‰à¹„à¸‚à¸ à¸²à¸žà¸•à¸²à¸¡à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸™à¸±à¹‰à¸™à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸„à¸£à¹ˆà¸‡à¸„à¸£à¸±à¸”à¹€à¸«à¸¡à¸·à¸­à¸™à¸à¸²à¸£à¸œà¹ˆà¸²à¸•à¸±à¸”à¸ˆà¸£à¸´à¸‡ à¸«à¹‰à¸²à¸¡à¸„à¸´à¸”à¹à¸—à¸™ à¸«à¹‰à¸²à¸¡à¹€à¸•à¸´à¸¡à¹à¸•à¹ˆà¸‡ à¹à¸¥à¸°à¸«à¹‰à¸²à¸¡à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸ªà¸±à¹ˆà¸‡à¹€à¸”à¹‡à¸”à¸‚à¸²à¸”

---

## ðŸ“¥ à¸ªà¹ˆà¸§à¸™à¸£à¸±à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥ (INPUT DATA)

**1. à¸ à¸²à¸žà¸•à¹‰à¸™à¸‰à¸šà¸±à¸š (Source Image):** [à¹à¸™à¸šà¹„à¸Ÿà¸¥à¹Œà¸ à¸²à¸žà¹ƒà¸šà¸«à¸™à¹‰à¸²à¸¥à¸¹à¸à¸„à¹‰à¸²à¸—à¸µà¹ˆà¸™à¸µà¹ˆ]

**2. à¹ƒà¸šà¸ªà¸±à¹ˆà¸‡à¸‡à¸²à¸™à¸«à¸±à¸•à¸–à¸à¸²à¸£ (Procedure Order):**
*(à¸£à¸°à¸šà¸¸à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸—à¸µà¹ˆà¸Šà¸±à¸”à¹€à¸ˆà¸™à¸—à¸²à¸‡à¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡ à¸«à¸£à¸·à¸­à¸Šà¸·à¹ˆà¸­à¸—à¸£à¸‡à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™à¸¡à¸²à¸•à¸£à¸à¸²à¸™ à¹€à¸Šà¹ˆà¸™ "à¹€à¸ªà¸£à¸´à¸¡à¸ˆà¸¡à¸¹à¸à¸—à¸£à¸‡à¸­à¹€à¸¡à¸£à¸´à¸à¸²à¹€à¸«à¸™à¸·à¸­ à¸ªà¸±à¸™à¸Šà¸±à¸” à¸›à¸¥à¸²à¸¢à¸žà¸¸à¹ˆà¸‡", "à¸¥à¸”à¸‚à¸™à¸²à¸”à¸›à¸µà¸à¸ˆà¸¡à¸¹à¸", "à¹€à¸•à¸´à¸¡à¸„à¸²à¸‡à¸§à¸µà¹€à¸Šà¸Ÿ")*

à¹€à¸¥à¸·à¸­à¸à¸«à¸±à¸•à¸–à¸à¸²à¸£: {SELECTED_PROCEDURES}
à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸„à¸³à¸ªà¸±à¹ˆà¸‡: {DETAILS}

---

## âš™ï¸ à¹‚à¸›à¸£à¹‚à¸•à¸„à¸­à¸¥à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™ (SYSTEM PROTOCOL)

**à¸à¸Žà¸‚à¹‰à¸­à¸—à¸µà¹ˆ 1: à¸à¸²à¸£à¸›à¸à¸´à¸šà¸±à¸•à¸´à¸•à¸²à¸¡à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸„à¸£à¹ˆà¸‡à¸„à¸£à¸±à¸” (Strict Execution)**
* à¸£à¸°à¸šà¸šà¸ˆà¸°à¸•à¹‰à¸­à¸‡à¸£à¸°à¸šà¸¸à¸­à¸§à¸±à¸¢à¸§à¸°à¹€à¸›à¹‰à¸²à¸«à¸¡à¸²à¸¢à¸ˆà¸²à¸ Input à¹à¸¥à¸°à¸—à¸³à¸à¸²à¸£à¹à¸à¹‰à¹„à¸‚à¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¸‚à¸­à¸‡à¸­à¸§à¸±à¸¢à¸§à¸°à¸™à¸±à¹‰à¸™ *à¹€à¸žà¸µà¸¢à¸‡à¸ˆà¸¸à¸”à¹€à¸”à¸µà¸¢à¸§*
* **à¸à¸²à¸£à¸•à¸µà¸„à¸§à¸²à¸¡à¸„à¸³à¸ªà¸±à¹ˆà¸‡:** à¸«à¸²à¸à¹„à¸”à¹‰à¸£à¸±à¸šà¸„à¸³à¸ªà¸±à¹ˆà¸‡à¹€à¸›à¹‡à¸™à¸Šà¸·à¹ˆà¸­à¸—à¸£à¸‡ (à¹€à¸Šà¹ˆà¸™ "à¸—à¸£à¸‡à¸­à¹€à¸¡à¸£à¸´à¸à¸²à¹€à¸«à¸™à¸·à¸­") à¹ƒà¸«à¹‰à¸›à¸£à¸±à¸šà¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¹ƒà¸«à¹‰à¸•à¸£à¸‡à¸•à¸²à¸¡à¸¥à¸±à¸à¸©à¸“à¸°à¸—à¸²à¸‡à¸à¸²à¸¢à¸§à¸´à¸ à¸²à¸„à¸‚à¸­à¸‡à¸—à¸£à¸‡à¸™à¸±à¹‰à¸™ (à¹€à¸Šà¹ˆà¸™ à¸ªà¸±à¸™à¸ˆà¸¡à¸¹à¸à¹‚à¸”à¹ˆà¸‡à¸„à¸¡à¸Šà¸±à¸”, à¸›à¸¥à¸²à¸¢à¸žà¸¸à¹ˆà¸‡à¹à¸•à¹ˆà¸¡à¸µà¸„à¸§à¸²à¸¡à¸¡à¸™, à¸à¸²à¸™à¹„à¸¡à¹ˆà¸à¸§à¹‰à¸²à¸‡à¹€à¸à¸´à¸™à¹„à¸›)

**à¸à¸Žà¸‚à¹‰à¸­à¸—à¸µà¹ˆ 2: à¸à¸²à¸£à¸¥à¹‡à¸­à¸à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸«à¸§à¸‡à¸«à¹‰à¸²à¸¡ (The 'Do Not Touch' Zone)**
à¹€à¸žà¸·à¹ˆà¸­à¸£à¸±à¸à¸©à¸²à¸„à¸§à¸²à¸¡à¹€à¸›à¹‡à¸™à¸•à¸±à¸§à¸•à¸™à¸‚à¸­à¸‡à¸¥à¸¹à¸à¸„à¹‰à¸²à¹à¸¥à¸°à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸šà¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œà¹„à¸”à¹‰à¸ˆà¸£à¸´à¸‡:
* âœ… **à¸¥à¹‡à¸­à¸à¸­à¸±à¸•à¸¥à¸±à¸à¸©à¸“à¹Œ (Identity Lock):** à¸”à¸§à¸‡à¸•à¸², à¸„à¸´à¹‰à¸§, à¸£à¸¹à¸›à¸›à¸²à¸, à¹‚à¸„à¸£à¸‡à¸«à¸™à¹‰à¸²à¸ªà¹ˆà¸§à¸™à¸­à¸·à¹ˆà¸™à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡ à¸•à¹‰à¸­à¸‡à¹€à¸«à¸¡à¸·à¸­à¸™à¸ à¸²à¸žà¸•à¹‰à¸™à¸‰à¸šà¸±à¸š 100%
* âœ… **à¸¥à¹‡à¸­à¸à¸•à¸³à¸«à¸™à¸´à¸œà¸´à¸§ (Imperfection Lock):** à¹„à¸, à¸›à¸²à¸™, à¸£à¸­à¸¢à¸ªà¸´à¸§, à¸£à¸­à¸¢à¹à¸œà¸¥à¹€à¸›à¹‡à¸™à¹€à¸”à¸´à¸¡à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆà¸™à¸­à¸à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¹à¸à¹‰à¹„à¸‚ à¸•à¹‰à¸­à¸‡à¸„à¸‡à¸­à¸¢à¸¹à¹ˆà¸«à¹‰à¸²à¸¡à¸¥à¸šà¸­à¸­à¸
* âœ… **à¸¥à¹‡à¸­à¸à¸šà¸£à¸´à¸šà¸— (Context Lock):** à¸—à¸£à¸‡à¸œà¸¡, à¸ªà¸µà¸œà¸´à¸§à¹€à¸”à¸´à¸¡, à¸‰à¸²à¸à¸«à¸¥à¸±à¸‡, à¹à¸ªà¸‡à¹€à¸‡à¸²à¸šà¸£à¸£à¸¢à¸²à¸à¸²à¸¨ à¸•à¹‰à¸­à¸‡à¹„à¸¡à¹ˆà¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡

**à¸à¸Žà¸‚à¹‰à¸­à¸—à¸µà¹ˆ 3: à¸„à¸§à¸²à¸¡à¸ªà¸¡à¸ˆà¸£à¸´à¸‡à¸£à¸°à¸”à¸±à¸šà¸„à¸¥à¸´à¸™à¸´à¸ (Clinical Realism & Integration)**
* **Texture à¸œà¸´à¸§à¸«à¸™à¸±à¸‡:** à¸šà¸£à¸´à¹€à¸§à¸“à¸—à¸µà¹ˆà¸–à¸¹à¸à¹à¸à¹‰à¹„à¸‚à¹ƒà¸«à¸¡à¹ˆ (à¹€à¸Šà¹ˆà¸™ à¸ˆà¸¡à¸¹à¸à¹ƒà¸«à¸¡à¹ˆ) à¸ˆà¸°à¸•à¹‰à¸­à¸‡à¸¡à¸µà¸žà¸·à¹‰à¸™à¸œà¸´à¸§ (Texture) à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™à¸œà¸´à¸§à¸«à¸™à¸±à¸‡à¸¡à¸™à¸¸à¸©à¸¢à¹Œà¸ˆà¸£à¸´à¸‡ à¸¡à¸µà¸£à¸¹à¸‚à¸¸à¸¡à¸‚à¸™ à¸¡à¸µà¸„à¸§à¸²à¸¡à¸¡à¸±à¸™à¹€à¸‡à¸²à¸•à¸²à¸¡à¸˜à¸£à¸£à¸¡à¸Šà¸²à¸•à¸´ à¸«à¹‰à¸²à¸¡à¸”à¸¹à¹€à¸£à¸µà¸¢à¸šà¹€à¸™à¸µà¸¢à¸™à¹€à¸«à¸¡à¸·à¸­à¸™à¸žà¸¥à¸²à¸ªà¸•à¸´à¸à¸«à¸£à¸·à¸­à¸ à¸²à¸žà¸§à¸²à¸”
* **à¸à¸²à¸£à¸œà¸ªà¸²à¸™à¹à¸ªà¸‡à¹€à¸‡à¸² (Lighting Integration):** à¹à¸ªà¸‡à¹à¸¥à¸°à¹€à¸‡à¸²à¸—à¸µà¹ˆà¸•à¸à¸à¸£à¸°à¸—à¸šà¸šà¸™à¸­à¸§à¸±à¸¢à¸§à¸°à¹ƒà¸«à¸¡à¹ˆ à¸•à¹‰à¸­à¸‡à¸ªà¸­à¸”à¸„à¸¥à¹‰à¸­à¸‡à¸à¸±à¸šà¸—à¸´à¸¨à¸—à¸²à¸‡à¹à¸ªà¸‡à¹€à¸”à¸´à¸¡à¹ƒà¸™à¸ à¸²à¸žà¸•à¹‰à¸™à¸‰à¸šà¸±à¸š à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸£à¸­à¸¢à¸•à¹ˆà¸­à¸”à¸¹à¹€à¸™à¸µà¸¢à¸™à¸ªà¸™à¸´à¸—à¹à¸¥à¸°à¸ªà¸¡à¸ˆà¸£à¸´à¸‡
* **à¸‚à¹‰à¸­à¸«à¹‰à¸²à¸¡à¸ªà¸³à¸„à¸±à¸:** à¸«à¹‰à¸²à¸¡à¹ƒà¸Šà¹‰à¸Ÿà¸´à¸¥à¹€à¸•à¸­à¸£à¹Œà¸šà¸´à¸§à¸•à¸µà¹‰, à¸«à¹‰à¸²à¸¡à¸›à¸£à¸±à¸šà¸ªà¸µà¸œà¸´à¸§à¹ƒà¸«à¹‰à¸‚à¸²à¸§à¸‚à¸¶à¹‰à¸™, à¸«à¹‰à¸²à¸¡à¹à¸•à¹ˆà¸‡à¸«à¸™à¹‰à¸²à¹€à¸žà¸´à¹ˆà¸¡à¹ƒà¸«à¹‰à¸•à¸±à¸§à¹à¸šà¸š à¸ à¸²à¸žà¸•à¹‰à¸­à¸‡à¸­à¸­à¸à¸¡à¸²à¸”à¸´à¸šà¹à¸¥à¸°à¸ˆà¸£à¸´à¸‡à¹€à¸«à¸¡à¸·à¸­à¸™à¸ à¸²à¸žà¸–à¹ˆà¸²à¸¢à¸—à¸²à¸‡à¸à¸²à¸£à¹à¸žà¸—à¸¢à¹Œ (Medical Photography)`;;

export const uploadImage = async (file) => {
    const formData = new FormData();
    formData.append('file', file);

    const response = await fetch('https://tmpfiles.org/api/v1/upload', {
        method: 'POST',
        body: formData,
    });

    const data = await response.json();
    if (data.status !== 'success') {
        throw new Error('Upload failed');
    }

    // Convert to direct URL if needed (tmpfiles.org usually requires /dl/)
    // Standard return: https://tmpfiles.org/123/name.jpg
    // Direct download: https://tmpfiles.org/dl/123/name.jpg
    // We will try using the direct DL format to be safe for AI processing
    let url = data.data.url;
    if (url.includes('tmpfiles.org/')) {
        url = url.replace('tmpfiles.org/', 'tmpfiles.org/dl/');
    }
    return url;
};

export const generateImage = async (imageUrl, selectedProcedures, details) => {
    const prompt = PROMPT_TEMPLATE
        .replace('{SELECTED_PROCEDURES}', selectedProcedures.join(', '))
        .replace('{DETAILS}', details);

    const body = {
        model: "nano-banana-pro",
        input: {
            prompt: prompt,
            aspect_ratio: "auto",
            resolution: "1K",
            output_format: "png",
            image_input: [imageUrl]
        }
    };

    const response = await fetch('https://api.kie.ai/api/v1/jobs/createTask', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${API_KEY}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
    });

    const data = await response.json();
    console.log('API Response (createTask):', data);

    if (!response.ok || !data.data) {
        throw new Error(data.message || data.error || 'Failed to create task');
    }

    return data.data.taskId;
};

export const pollTaskResult = async (taskId) => {
    const poll = async () => {
        const response = await fetch(`https://api.kie.ai/api/v1/jobs/recordInfo?taskId=${taskId}`, {
            headers: {
                'Authorization': `Bearer ${API_KEY}`
            }
        });
        const data = await response.json();

        if (data.data.state === 'success') {
            let resultData = data.data.resultJson;
            if (typeof resultData === 'string') {
                resultData = JSON.parse(resultData);
            }
            return resultData.resultUrls[0];
        } else if (data.data.state === 'failed') {
            throw new Error('Task failed');
        }

        return null; // Still running
    };

    // Poll indefinitely until success or failure
    while (true) {
        const result = await poll();
        if (result) return result;
        await new Promise(resolve => setTimeout(resolve, 2000));
    }
};
